<?xml version="1.0"?>
<!--
/**
 * Copyright Â© 2015 Magento. All rights reserved.
 * See COPYING.txt for license details.
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <virtualType name="TnsConfig" type="Magento\Payment\Gateway\Config\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">OnTap\Tns\Model\Ui\Direct\ConfigProvider::METHOD_CODE</argument>
        </arguments>
    </virtualType>
    <virtualType name="TnsHostedConfig" type="Magento\Payment\Gateway\Config\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">OnTap\Tns\Model\Ui\Hosted\ConfigProvider::METHOD_CODE</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectFacade" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">OnTap\Tns\Model\Ui\Direct\ConfigProvider::METHOD_CODE</argument>
            <argument name="formBlockType" xsi:type="string">Magento\Payment\Block\Form\Cc</argument>
            <argument name="infoBlockType" xsi:type="string">OnTap\Tns\Block\Direct\Info</argument>
            <argument name="valueHandlerPool" xsi:type="object">TnsValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">TnsValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">TnsDirectCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsHostedFacade" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">OnTap\Tns\Model\Ui\Hosted\ConfigProvider::METHOD_CODE</argument>
            <argument name="formBlockType" xsi:type="string">Magento\Payment\Block\Form\Cc</argument>
            <argument name="infoBlockType" xsi:type="string">Magento\Payment\Block\Info\Cc</argument>
            <argument name="valueHandlerPool" xsi:type="object">TnsHostedValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">TnsValidatorPool</argument>
            <!--<argument name="commandPool" xsi:type="object">TnsDirectCommandPool</argument>-->
        </arguments>
    </virtualType>

    <virtualType name="TnsConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">TnsConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="TnsHostedConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">TnsHostedConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsHostedValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">TnsHostedConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="TnsValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">TnsConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">TnsConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsGlobalValidator" type="Magento\Payment\Gateway\Validator\ValidatorComposite">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">CountryValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="global" xsi:type="string">TnsGlobalValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Pure authorize command -->
    <type name="OnTap\Tns\Gateway\Command\AuthorizeCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">TnsDirectAuthorizeDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">TnsDirectTransferFactory</argument>
            <argument name="client" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Rest</argument>
            <argument name="handler" xsi:type="object">TnsDirectAuthorizeResponseHandler</argument>
            <argument name="validator" xsi:type="object">OnTap\Tns\Gateway\Validator\Direct\ResponseValidator</argument>
        </arguments>
        <plugin name="CheckThreeDSecureEnrollment" type="OnTap\Tns\Gateway\Plugin\ThreeDSecureEnrollment" sortOrder="0" />
    </type>

    <!-- Authorize + Capture command aka. Sale -->
    <virtualType name="TnsDirectSaleCommand" type="OnTap\Tns\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">TnsDirectSaleDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">TnsDirectTransferFactory</argument>
            <argument name="client" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Rest</argument>
            <argument name="handler" xsi:type="object">TnsDirectSaleResponseHandler</argument>
            <argument name="validator" xsi:type="object">OnTap\Tns\Gateway\Validator\Direct\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Capture a pre-authorized payment -->
    <virtualType name="TnsPreAuthCaptureCommand" type="OnTap\Tns\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">TnsDirectCaptureDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">TnsDirectTransferFactory</argument>
            <argument name="client" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Rest</argument>
            <argument name="handler" xsi:type="object">OnTap\Tns\Gateway\Response\Direct\TransactionIdHandler</argument>
            <argument name="validator" xsi:type="object">OnTap\Tns\Gateway\Validator\Direct\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Refund -->
    <virtualType name="TnsDirectRefundCommand" type="OnTap\Tns\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">TnsDirectRefundDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">TnsDirectTransferFactory</argument>
            <argument name="client" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Rest</argument>
            <argument name="validator" xsi:type="object">OnTap\Tns\Gateway\Validator\Direct\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Void -->
    <virtualType name="TnsDirectVoidCommand" type="OnTap\Tns\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">TnsDirectVoidDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">TnsDirectTransferFactory</argument>
            <argument name="client" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Rest</argument>
            <argument name="validator" xsi:type="object">OnTap\Tns\Gateway\Validator\Direct\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Check 3D-Secure enrollment -->
    <virtualType name="TnsDirect3dsEnrollmentCommand" type="OnTap\Tns\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">OnTap\Tns\Gateway\Request\Direct\ThreeDSecureDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">TnsDirectThreeDSecureTransferFactory</argument>
            <argument name="client" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Rest</argument>
            <argument name="validator" xsi:type="object">OnTap\Tns\Gateway\Validator\Direct\ThreeDSecureValidator</argument>
        </arguments>
    </virtualType>

    <type name="OnTap\Tns\Gateway\Plugin\ThreeDSecureEnrollment">
        <arguments>
            <argument name="config" xsi:type="object">TnsConfig</argument>
            <argument name="commandPool" xsi:type="object">TnsDirectCommandPool</argument>
        </arguments>
    </type>

    <type name="OnTap\Tns\Gateway\Http\Client\Rest">
        <arguments>
            <argument name="logger" xsi:type="object">TnsLogger</argument>
            <argument name="converter" xsi:type="object">OnTap\Tns\Gateway\Http\Converter\JsonToArray</argument>
            <argument name="adapter" xsi:type="object">OnTap\Tns\Gateway\Http\Client\Adapter\Rest</argument>
        </arguments>
    </type>

    <type name="OnTap\Tns\Gateway\Validator\Direct\ResponseValidator">
        <arguments>
            <argument name="config" xsi:type="object">TnsConfig</argument>
        </arguments>
    </type>

    <virtualType name="TnsDirectCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">OnTap\Tns\Gateway\Command\AuthorizeCommand</item>
                <item name="capture" xsi:type="string">TnsDirectCaptureStrategyCommand</item>
                <item name="sale" xsi:type="string">TnsDirectSaleCommand</item>
                <item name="pre_auth_capture" xsi:type="string">TnsPreAuthCaptureCommand</item>
                <item name="refund" xsi:type="string">TnsDirectRefundCommand</item>
                <item name="void" xsi:type="string">TnsDirectVoidCommand</item>
                <item name="3ds_enrollment" xsi:type="string">TnsDirect3dsEnrollmentCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectCaptureStrategyCommand" type="OnTap\Tns\Gateway\Command\CaptureStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">TnsDirectCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectTransferFactory" type="OnTap\Tns\Gateway\Http\TransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">TnsConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="TnsDirectThreeDSecureTransferFactory" type="OnTap\Tns\Gateway\Http\ThreeDSecureTransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">TnsConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsLogger" type="Magento\Payment\Model\Method\Logger">
        <arguments>
            <argument name="config" xsi:type="object">TnsConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectAuthorizeDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="authorize" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\AuthorizeDataBuilder</item>
                <item name="card" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\CardDataBuilder</item>
                <item name="order" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\OrderDataBuilder</item>
                <item name="billing" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\CustomerDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectSaleDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="sale" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\SaleDataBuilder</item>
                <item name="card" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\CardDataBuilder</item>
                <item name="order" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\OrderDataBuilder</item>
                <item name="billing" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\CustomerDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectVoidDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="void" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\VoidDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectRefundDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="refund" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\RefundDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectCaptureDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="capture" xsi:type="string">OnTap\Tns\Gateway\Request\Direct\CaptureDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectAuthorizeResponseHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="transaction" xsi:type="string">OnTap\Tns\Gateway\Response\Direct\TransactionIdHandler</item>
                <item name="authorize" xsi:type="string">OnTap\Tns\Gateway\Response\Direct\AuthorizeHandler</item>
                <item name="payment" xsi:type="string">OnTap\Tns\Gateway\Response\Direct\PaymentHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="TnsDirectSaleResponseHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="transaction" xsi:type="string">OnTap\Tns\Gateway\Response\Direct\TransactionIdHandler</item>
                <item name="payment" xsi:type="string">OnTap\Tns\Gateway\Response\Direct\PaymentHandler</item>
            </argument>
        </arguments>
    </virtualType>

</config>
